{% extends "base.html" %}
{% block title %} {{ player.gamertag }} - Player Stats {% endblock %}
{% block header_text %} Player Performance: {{ player.gamertag }} {% endblock %}

{% block main %}
<div class="container my-4">
  <div class="row">
    <!-- player profile -->
    <div class="col-md-4">
      <div class="card">
        <div class="mx-auto pt-4 pb-3 text-center ">
          {% if current_user.profile_picture %}
            <img src="{{ url_for('static', filename=current_user.profile_picture) }}"
                class="rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">
          {% else %}
            <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-2 border border-2" 
                 style="width: 150px; height: 150px;">
              <i class="bi bi-person" style="font-size: 5rem; color: #6c757d;"></i>
            </div>
          {% endif %}
          <br>
        </div>
        <div class="card-body">
          <h5 class="card-title">Player Name</h5>
          <p class="card-text">@{{ player.gamertag }}</p>
        </div>
      </div>
    </div>

    <!-- list of games/rounds played in this tournament -->
    <div class="col-md-8">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Games Stats</h5>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="viewDropdown"
                data-bs-toggle="dropdown" aria-expanded="false">
                This Tournament
              </button>
              <ul class="dropdown-menu" aria-labelledby="viewDropdown">
                <li><a class="dropdown-item active" href="#" onclick="switchGameView('tournament')">This Tournament</a>
                </li>
                <li><a class="dropdown-item" href="#" onclick="switchGameView('game')">Game View</a></li>
                <li><a class="dropdown-item" href="#" onclick="switchGameView('overall')">Career</a></li>
              </ul>
            </div>
          </div>

          <div id="game-view-tournament" class="game-table-view">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th scope="col">Round</th>
                  <th scope="col">Team Rank</th>
                  <th scope="col">Kills</th>
                  <th scope="col">Deaths</th>
                  <th scope="col">Assists</th>
                  <th scope="col">Medals</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><a href="/tournament/game?id=1">Game 1</a></td>
                  <td>4th</td>
                  <td>20</td>
                  <td>5</td>
                  <td>10</td>
                  <td>0</td>
                </tr>
                <tr>
                  <td><a href="/tournament/game?id=2">Game 2</a></td>
                  <td>2nd</td>
                  <td>25</td>
                  <td>8</td>
                  <td>12</td>
                  <td>1</td>
                </tr>
                <tr>
                  <td><a href="/tournament/game?id=3">Game 3</a></td>
                  <td>1st (MVP)</td>
                  <td>30</td>
                  <td>6</td>
                  <td>15</td>
                  <td>3</td>
                </tr>
                <tr>
                  <td><strong>Total</strong></td>
                  <td>-</td>
                  <td><strong>75</strong></td>
                  <td><strong>19</strong></td>
                  <td><strong>37</strong></td>
                  <td><strong>4</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="game-view-game" class="game-table-view" style="display:none;">
            {% if current_game %}
            {% set gp = player.game_players | selectattr("game_id", "equalto", current_game.id) | list | first %}
            {% if gp %}
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Hero</th>
                  <th>Kills</th>
                  <th>Deaths</th>
                  <th>Assists</th>
                  <th>Damage</th>
                  <th>Healing</th>
                  <th>Accuracy</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{{ gp.hero.hero_name if gp.hero else "Unknown" }}</td>
                  <td>{{ gp.kills }}</td>
                  <td>{{ gp.deaths }}</td>
                  <td>{{ gp.assists }}</td>
                  <td>{{ gp.damage }}</td>
                  <td>{{ gp.healing }}</td>
                  <td>{{ gp.accuracy_pct }}%</td>
                </tr>
              </tbody>
            </table>
            {% else %}
            <p>This player did not participate in this game.</p>
            {% endif %}
            {% else %}
            <p>No game selected. Please provide a game ID using `?g=GAME_ID` in the URL.</p>
            {% endif %}
          </div>


          <div id="game-view-overall" class="game-table-view" style="display:none;">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Game ID</th>
                  <th>Tournament</th>
                  <th>Team</th>
                  <th>Kills</th>
                  <th>Deaths</th>
                  <th>Assists</th>
                  <th>Damage</th>
                </tr>
              </thead>
              <tbody>
                {% for gp in player.game_players %}
                <tr>
                  <td>
                    <a href="/tournament/game?id={{ gp.game.id }}">
                      Round {{ gp.game.round }}
                    </a>
                  </td>
                  <td>
                    <a href="/tournament?id={{ gp.game.tournament.id }}">
                      {{ gp.game.tournament.title }}
                    </a>
                  </td>
                  <td>
                    {% if gp.team_id == gp.game.team_a.id %}
                    {{ gp.game.team_a.team_name }}
                    {% elif gp.team_id == gp.game.team_b.id %}
                    {{ gp.game.team_b.team_name }}
                    {% else %}
                    Unknown
                    {% endif %}
                  </td>
                  <td>{{ gp.kills }}</td>
                  <td>{{ gp.deaths }}</td>
                  <td>{{ gp.assists }}</td>
                  <td>{{ gp.damage }}</td>
                </tr>
                {% endfor %}
              </tbody>

            </table>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- stats from this tournament -->
  <div class="row mt-4">
    <div class="col-md-8">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Average Damage Per Game</h5>
              <p class="card-text">1500</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Average Healing</h5>
              <p class="card-text">500</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Average Damage Blocked</h5>
              <p class="card-text">300</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Top Hero</h5>
              <p class="card-text">Iron Man</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Win Rate</h5>
              <p class="card-text">65%</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Participation</h5>
              <p class="card-text">3/4 games</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Average Accuracy</h5>
              <p class="card-text">48%</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Most Kills in a Game</h5>
              <p class="card-text">30</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4 d-flex align-items-center">
      <div class="card w-100 h-100">
        <div class="card-body d-flex align-items-center justify-content-center">
          <img src="{{url_for('static', filename='images/spider-placeholder.png')}}" alt="Spider Chart Placeholder"
            class="img-fluid" style="max-width: 100%; height: auto; aspect-ratio: 1 / 1;">
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function switchGameView(view) {
    document.getElementById("viewDropdown").textContent =
      view === "tournament" ? "This Tournament" :
        view === "game" ? "This Game" :
          "Overall";
    document.querySelectorAll(".dropdown-item").forEach(item => item.classList.remove("active"));
    document.querySelector(`.dropdown-item[onclick="switchGameView('${view}')"]`).classList.add("active");
    // display hidden sections
    document.querySelectorAll(".game-table-view").forEach(div => div.style.display = "none");
    const section = document.getElementById(`game-view-${view}`);
    if (section) section.style.display = "block";
  }
</script>
{% endblock %}