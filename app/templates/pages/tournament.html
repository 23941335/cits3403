{% extends "base.html" %}

{% block title %}Tournament Manager{% endblock %}

{% block header_text %}Marvel Rivals Tournament Manager{% endblock %}

{% block style %}
<style>
  .hover-shadow:hover {
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    transform: translateY(-2px);
    transition: all 0.2s ease-in-out;
  }
</style>
{% endblock %}

{% block main %}
<h1>Tournament——{{ tournament.title }}</h1>
<p>{{ tournament.description }}</p>
<p>Start Time: {{ tournament.start_time.strftime('%Y-%m-%d %H:%M') }}</p>
<p>Visibility: {{ tournament.visibility.visibility }}</p>

<button type="submit" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#shareModal">
  Share
</button>

<!-- Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" role="dialog" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="shareModalLabel">Modal title</h5>
        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="container">
        <h2>Select Users</h2>
        <form id="shareForm" action="/tournament/share" method="POST">
          {{ form.hidden_tag() }}

          <div class="mb-3">
            <label for="selectUser" class="form-label">Share</label>
            <select id="selectUser" class="form-select">
              <option value="" disabled selected>Select a User</option>
              {% for user in unsharedUsers %}
                <option value="{{ user.id }}">{{ user.username }}</option>
              {% endfor %}
            </select>
          </div>

          {{ form.tid() }}

          <div class="mb-3">
            <h5>Selected Users</h5>
            <ul id="selectedUsersList" class="list-group mb-2">
              {% for user in sharedUsers %}
                <li class="list-group-item d-flex justify-content-between align-items-center" data-user-id="{{ user.id }}">
                  {{ user.username }}
                  <button class="btn btn-sm btn-danger" onclick="removeUser('{{ user.id }}', '{{ user.username }}')">Remove</button>
                </li>
              {% endfor %}
            </ul>
            {{ form.selected_users(id="selected_users", value=selectedUsers | map(attribute='id') | join(',')) }}
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">Close</button>
        {{ form.submit(class="btn btn-primary", form="shareForm") }}
      </div>
    </div>
  </div>
</div>

<script>
  const selectUser = document.getElementById('selectUser');
  const selectedUsersList = document.getElementById('selectedUsersList');
  const selectedUsersInput = document.getElementById('selected_users');
  let selectedUserIds = new Set();

  function removeUser(userId, userName) {
    const listItem = selectedUsersList.querySelector(`li[data-user-id="${userId}"]`);
    if (listItem) {
      selectedUsersList.removeChild(listItem);
      selectedUserIds.delete(userId);
      updateHiddenInput();

      // Re-add to dropdown
      const option = document.createElement('option');
      option.value = userId;
      option.textContent = userName;
      selectUser.appendChild(option);
    }
  }

  selectUser.addEventListener('change', function () {
    const selectedId = this.value;
    const selectedName = this.options[this.selectedIndex].text;

    if (!selectedUserIds.has(selectedId)) {
      selectedUserIds.add(selectedId);

      const listItem = document.createElement('li');
      listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
      listItem.textContent = selectedName;

      const removeBtn = document.createElement('button');
      removeBtn.className = 'btn btn-sm btn-danger';
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = () => {
        selectedUsersList.removeChild(listItem);
        selectedUserIds.delete(selectedId);
        updateHiddenInput();
        // Add back to dropdown
        const option = document.createElement('option');
        option.value = selectedId;
        option.textContent = selectedName;
        selectUser.appendChild(option);
      };

      listItem.appendChild(removeBtn);
      selectedUsersList.appendChild(listItem);
      updateHiddenInput();

      // Remove the selected user from the dropdown
      const selectedOption = selectUser.querySelector(`option[value="${selectedId}"]`);
      if (selectedOption) {
        selectUser.removeChild(selectedOption);
      }

      selectUser.value = "";
    }
  });

  function updateHiddenInput() {
    selectedUsersInput.value = Array.from(selectedUserIds).join(',');
  }
</script>

<h4 class="mt-4 mb-3">Teams Participating</h4>
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
  {% for team in teams %}
  {% set status = team_status.get(team.id, 'unknown') %}
  {% set card_color = 
      'bg-warning text-dark' if status == 'winner' else 
      'bg-light text-muted' if status == 'loser' else 
      'bg-light text-dark' %}
  <div class="col">
    <a href="/tournament/team?id={{ team.id }}&t={{ tournament.id }}" class="text-decoration-none">
      <div class="card h-100 text-center {{ card_color }} hover-shadow">
        <div class="card-body">
          <h5 class="card-title">{{ team.team_name }}</h5>
        </div>
      </div>
    </a>
  </div>
  {% endfor %}
</div>

<h2 class="mt-4">Games in This Tournament</h2>

{% if games %}
<div class="table-responsive">
  <table class="table table-striped table-bordered">
    <thead class="table-dark">
      <tr>
        <th>Round</th>
        <th>Team A</th>
        <th>Team B</th>
        <th>Game Mode</th>
        <th>Map</th>
        <th>Result</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody>
      {% for g in games %}
      <tr>
        <td>{{ g.round }}</td>
        <td>{{ g.team_a.team_name }}</td>
        <td>{{ g.team_b.team_name }}</td>
        <td>{{ g.game_mode.game_mode_name }}</td>
        <td>{{ g.map.map_name }}</td>
        <td>
          {% if g.is_draw %}
          Draw
          {% elif g.winning_team == g.team_a.id %}
          {{ g.team_a.team_name }} Wins
          {% elif g.winning_team == g.team_b.id %}
          {{ g.team_b.team_name }} Wins
          {% else %}
          Unknown
          {% endif %}
        </td>
        <td>
          <a class="btn btn-sm btn-outline-primary me-2" href="/tournament/game?id={{ g.id }}">Full View</a>
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
            data-bs-target="#details-{{ g.id }}" aria-expanded="false" aria-controls="details-{{ g.id }}">
            Players
          </button>
        </td>
      </tr>
      <tr class="collapse" id="details-{{ g.id }}">
        <td colspan="7">
          <div class="border p-3">
            <h5 class="mb-3">Players in this Game</h5>
            <div class="row">
              <!-- Left Column: Team A -->
              <div class="col-md-6">
                <h6 class="text-center">{{ g.team_a.team_name }}</h6>
                {% for gp in g.game_players if gp.team_id == g.team_a.id %}
                <div class="card mb-2 p-2">
                  <h6 class="card-title">
                    {{ gp.player.gamertag }}
                    {% if g.mvp and gp.player.id == g.mvp.id %}
                    <span class="badge bg-warning text-dark ms-2">MVP</span>
                    {% elif g.svp and gp.player.id == g.svp.id %}
                    <span class="badge bg-info text-dark ms-2">SVP</span>
                    {% endif %}
                  </h6>
                  <p class="mb-1">Hero: {{ gp.hero.hero_name if gp.hero else 'Unknown' }}</p>
                  <p class="mb-1">Kills / Deaths / Assists: {{ gp.kills }} / {{ gp.deaths }} / {{ gp.assists }}</p>
                  <p class="mb-1">Damage: {{ gp.damage }} | Healing: {{ gp.healing }} | Accuracy: {{ gp.accuracy_pct }}%
                  </p>
                </div>
                {% endfor %}
              </div>

              <!-- Right Column: Team B -->
              <div class="col-md-6">
                <h6 class="text-center">{{ g.team_b.team_name }}</h6>
                {% for gp in g.game_players if gp.team_id == g.team_b.id %}
                <div class="card mb-2 p-2">
                  <h6 class="card-title">
                    {{ gp.player.gamertag }}
                    {% if g.mvp and gp.player.id == g.mvp.id %}
                    <span class="badge bg-warning text-dark ms-2">MVP</span>
                    {% elif g.svp and gp.player.id == g.svp.id %}
                    <span class="badge bg-info text-dark ms-2">SVP</span>
                    {% endif %}
                  </h6>
                  <p class="mb-1">Hero: {{ gp.hero.hero_name if gp.hero else 'Unknown' }}</p>
                  <p class="mb-1">Kills / Deaths / Assists: {{ gp.kills }} / {{ gp.deaths }} / {{ gp.assists }}</p>
                  <p class="mb-1">Damage: {{ gp.damage }} | Healing: {{ gp.healing }} | Accuracy: {{ gp.accuracy_pct }}%
                  </p>
                </div>
                {% endfor %}
              </div>
            </div>

          </div>
        </td>
      </tr>

      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p>No games found for this tournament.</p>
{% endif %}


{% endblock %}